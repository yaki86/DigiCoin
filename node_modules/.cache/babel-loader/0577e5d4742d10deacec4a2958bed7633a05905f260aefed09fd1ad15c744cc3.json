{"ast":null,"code":"import { Hub } from '@aws-amplify/core';\nimport { isBrowser, assertTokenProviderConfig, isTokenExpired, AMPLIFY_SYMBOL, AmplifyErrorCode } from '@aws-amplify/core/internals/utils';\nimport { assertServiceError } from '../../../errors/utils/assertServiceError.mjs';\nimport { AuthError } from '../../../errors/AuthError.mjs';\nimport { oAuthStore } from '../utils/oauth/oAuthStore.mjs';\nimport { addInflightPromise } from '../utils/oauth/inflightPromise.mjs';\n\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nclass TokenOrchestrator {\n  constructor() {\n    this.waitForInflightOAuth = isBrowser() ? async () => {\n      if (!(await oAuthStore.loadOAuthInFlight())) {\n        return;\n      }\n      if (this.inflightPromise) {\n        return this.inflightPromise;\n      }\n      // when there is valid oauth config and there is an inflight oauth flow, try\n      // to block async calls that require fetching tokens before the oauth flow completes\n      // e.g. getCurrentUser, fetchAuthSession etc.\n      this.inflightPromise = new Promise((resolve, _reject) => {\n        addInflightPromise(resolve);\n      });\n      return this.inflightPromise;\n    } : async () => {\n      // no-op for non-browser environments\n    };\n  }\n  setAuthConfig(authConfig) {\n    oAuthStore.setAuthConfig(authConfig.Cognito);\n    this.authConfig = authConfig;\n  }\n  setTokenRefresher(tokenRefresher) {\n    this.tokenRefresher = tokenRefresher;\n  }\n  setAuthTokenStore(tokenStore) {\n    this.tokenStore = tokenStore;\n  }\n  getTokenStore() {\n    if (!this.tokenStore) {\n      throw new AuthError({\n        name: 'EmptyTokenStoreException',\n        message: 'TokenStore not set'\n      });\n    }\n    return this.tokenStore;\n  }\n  getTokenRefresher() {\n    if (!this.tokenRefresher) {\n      throw new AuthError({\n        name: 'EmptyTokenRefresherException',\n        message: 'TokenRefresher not set'\n      });\n    }\n    return this.tokenRefresher;\n  }\n  async getTokens(options) {\n    let tokens;\n    try {\n      assertTokenProviderConfig(this.authConfig?.Cognito);\n    } catch (_err) {\n      // Token provider not configured\n      return null;\n    }\n    await this.waitForInflightOAuth();\n    this.inflightPromise = undefined;\n    tokens = await this.getTokenStore().loadTokens();\n    const username = await this.getTokenStore().getLastAuthUser();\n    if (tokens === null) {\n      return null;\n    }\n    const idTokenExpired = !!tokens?.idToken && isTokenExpired({\n      expiresAt: (tokens.idToken?.payload?.exp ?? 0) * 1000,\n      clockDrift: tokens.clockDrift ?? 0\n    });\n    const accessTokenExpired = isTokenExpired({\n      expiresAt: (tokens.accessToken?.payload?.exp ?? 0) * 1000,\n      clockDrift: tokens.clockDrift ?? 0\n    });\n    if (options?.forceRefresh || idTokenExpired || accessTokenExpired) {\n      tokens = await this.refreshTokens({\n        tokens,\n        username\n      });\n      if (tokens === null) {\n        return null;\n      }\n    }\n    return {\n      accessToken: tokens?.accessToken,\n      idToken: tokens?.idToken,\n      signInDetails: tokens?.signInDetails\n    };\n  }\n  async refreshTokens(_ref) {\n    let {\n      tokens,\n      username\n    } = _ref;\n    try {\n      const {\n        signInDetails\n      } = tokens;\n      const newTokens = await this.getTokenRefresher()({\n        tokens,\n        authConfig: this.authConfig,\n        username\n      });\n      newTokens.signInDetails = signInDetails;\n      await this.setTokens({\n        tokens: newTokens\n      });\n      Hub.dispatch('auth', {\n        event: 'tokenRefresh'\n      }, 'Auth', AMPLIFY_SYMBOL);\n      return newTokens;\n    } catch (err) {\n      return this.handleErrors(err);\n    }\n  }\n  handleErrors(err) {\n    assertServiceError(err);\n    if (err.name !== AmplifyErrorCode.NetworkError) {\n      // TODO(v6): Check errors on client\n      this.clearTokens();\n    }\n    Hub.dispatch('auth', {\n      event: 'tokenRefresh_failure',\n      data: {\n        error: err\n      }\n    }, 'Auth', AMPLIFY_SYMBOL);\n    if (err.name.startsWith('NotAuthorizedException')) {\n      return null;\n    }\n    throw err;\n  }\n  async setTokens(_ref2) {\n    let {\n      tokens\n    } = _ref2;\n    return this.getTokenStore().storeTokens(tokens);\n  }\n  async clearTokens() {\n    return this.getTokenStore().clearTokens();\n  }\n  getDeviceMetadata(username) {\n    return this.getTokenStore().getDeviceMetadata(username);\n  }\n  clearDeviceMetadata(username) {\n    return this.getTokenStore().clearDeviceMetadata(username);\n  }\n  setOAuthMetadata(metadata) {\n    return this.getTokenStore().setOAuthMetadata(metadata);\n  }\n  getOAuthMetadata() {\n    return this.getTokenStore().getOAuthMetadata();\n  }\n}\nexport { TokenOrchestrator };","map":{"version":3,"names":["TokenOrchestrator","constructor","waitForInflightOAuth","isBrowser","oAuthStore","loadOAuthInFlight","inflightPromise","Promise","resolve","_reject","addInflightPromise","setAuthConfig","authConfig","Cognito","setTokenRefresher","tokenRefresher","setAuthTokenStore","tokenStore","getTokenStore","AuthError","name","message","getTokenRefresher","getTokens","options","tokens","assertTokenProviderConfig","_err","undefined","loadTokens","username","getLastAuthUser","idTokenExpired","idToken","isTokenExpired","expiresAt","payload","exp","clockDrift","accessTokenExpired","accessToken","forceRefresh","refreshTokens","signInDetails","_ref","newTokens","setTokens","Hub","dispatch","event","AMPLIFY_SYMBOL","err","handleErrors","assertServiceError","AmplifyErrorCode","NetworkError","clearTokens","data","error","startsWith","_ref2","storeTokens","getDeviceMetadata","clearDeviceMetadata","setOAuthMetadata","metadata","getOAuthMetadata"],"sources":["/Users/yaki/digi-coin/digi-coin-app/node_modules/@aws-amplify/auth/src/providers/cognito/tokenProvider/TokenOrchestrator.ts"],"sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport { Hub, } from '@aws-amplify/core';\nimport { AMPLIFY_SYMBOL, AmplifyErrorCode, assertTokenProviderConfig, isBrowser, isTokenExpired, } from '@aws-amplify/core/internals/utils';\nimport { assertServiceError } from '../../../errors/utils/assertServiceError';\nimport { AuthError } from '../../../errors/AuthError';\nimport { oAuthStore } from '../utils/oauth/oAuthStore';\nimport { addInflightPromise } from '../utils/oauth/inflightPromise';\nexport class TokenOrchestrator {\n    constructor() {\n        this.waitForInflightOAuth = isBrowser()\n            ? async () => {\n                if (!(await oAuthStore.loadOAuthInFlight())) {\n                    return;\n                }\n                if (this.inflightPromise) {\n                    return this.inflightPromise;\n                }\n                // when there is valid oauth config and there is an inflight oauth flow, try\n                // to block async calls that require fetching tokens before the oauth flow completes\n                // e.g. getCurrentUser, fetchAuthSession etc.\n                this.inflightPromise = new Promise((resolve, _reject) => {\n                    addInflightPromise(resolve);\n                });\n                return this.inflightPromise;\n            }\n            : async () => {\n                // no-op for non-browser environments\n            };\n    }\n    setAuthConfig(authConfig) {\n        oAuthStore.setAuthConfig(authConfig.Cognito);\n        this.authConfig = authConfig;\n    }\n    setTokenRefresher(tokenRefresher) {\n        this.tokenRefresher = tokenRefresher;\n    }\n    setAuthTokenStore(tokenStore) {\n        this.tokenStore = tokenStore;\n    }\n    getTokenStore() {\n        if (!this.tokenStore) {\n            throw new AuthError({\n                name: 'EmptyTokenStoreException',\n                message: 'TokenStore not set',\n            });\n        }\n        return this.tokenStore;\n    }\n    getTokenRefresher() {\n        if (!this.tokenRefresher) {\n            throw new AuthError({\n                name: 'EmptyTokenRefresherException',\n                message: 'TokenRefresher not set',\n            });\n        }\n        return this.tokenRefresher;\n    }\n    async getTokens(options) {\n        let tokens;\n        try {\n            assertTokenProviderConfig(this.authConfig?.Cognito);\n        }\n        catch (_err) {\n            // Token provider not configured\n            return null;\n        }\n        await this.waitForInflightOAuth();\n        this.inflightPromise = undefined;\n        tokens = await this.getTokenStore().loadTokens();\n        const username = await this.getTokenStore().getLastAuthUser();\n        if (tokens === null) {\n            return null;\n        }\n        const idTokenExpired = !!tokens?.idToken &&\n            isTokenExpired({\n                expiresAt: (tokens.idToken?.payload?.exp ?? 0) * 1000,\n                clockDrift: tokens.clockDrift ?? 0,\n            });\n        const accessTokenExpired = isTokenExpired({\n            expiresAt: (tokens.accessToken?.payload?.exp ?? 0) * 1000,\n            clockDrift: tokens.clockDrift ?? 0,\n        });\n        if (options?.forceRefresh || idTokenExpired || accessTokenExpired) {\n            tokens = await this.refreshTokens({\n                tokens,\n                username,\n            });\n            if (tokens === null) {\n                return null;\n            }\n        }\n        return {\n            accessToken: tokens?.accessToken,\n            idToken: tokens?.idToken,\n            signInDetails: tokens?.signInDetails,\n        };\n    }\n    async refreshTokens({ tokens, username, }) {\n        try {\n            const { signInDetails } = tokens;\n            const newTokens = await this.getTokenRefresher()({\n                tokens,\n                authConfig: this.authConfig,\n                username,\n            });\n            newTokens.signInDetails = signInDetails;\n            await this.setTokens({ tokens: newTokens });\n            Hub.dispatch('auth', { event: 'tokenRefresh' }, 'Auth', AMPLIFY_SYMBOL);\n            return newTokens;\n        }\n        catch (err) {\n            return this.handleErrors(err);\n        }\n    }\n    handleErrors(err) {\n        assertServiceError(err);\n        if (err.name !== AmplifyErrorCode.NetworkError) {\n            // TODO(v6): Check errors on client\n            this.clearTokens();\n        }\n        Hub.dispatch('auth', {\n            event: 'tokenRefresh_failure',\n            data: { error: err },\n        }, 'Auth', AMPLIFY_SYMBOL);\n        if (err.name.startsWith('NotAuthorizedException')) {\n            return null;\n        }\n        throw err;\n    }\n    async setTokens({ tokens }) {\n        return this.getTokenStore().storeTokens(tokens);\n    }\n    async clearTokens() {\n        return this.getTokenStore().clearTokens();\n    }\n    getDeviceMetadata(username) {\n        return this.getTokenStore().getDeviceMetadata(username);\n    }\n    clearDeviceMetadata(username) {\n        return this.getTokenStore().clearDeviceMetadata(username);\n    }\n    setOAuthMetadata(metadata) {\n        return this.getTokenStore().setOAuthMetadata(metadata);\n    }\n    getOAuthMetadata() {\n        return this.getTokenStore().getOAuthMetadata();\n    }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}